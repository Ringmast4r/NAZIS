<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WP Determiner - Database Viewer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a0a;
    color: #e0e0e0;
    font-family: 'Consolas', 'Courier New', monospace;
    padding: 20px;
  }
  h1 {
    color: #00b4ff;
    font-size: 22px;
    margin-bottom: 4px;
  }
  .subtitle {
    color: #3cc8ff;
    font-size: 13px;
    margin-bottom: 20px;
  }
  .controls {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .controls label {
    color: #80c8e0;
    font-size: 13px;
  }
  input[type="file"] { display: none; }
  .btn {
    background: #00587a;
    color: #c0ecff;
    border: 1px solid #007aaa;
    padding: 8px 16px;
    font-family: inherit;
    font-size: 13px;
    cursor: pointer;
    border-radius: 3px;
  }
  .btn:hover { background: #007aaa; }
  .btn.active { background: #00b4ff; color: #000; }
  input[type="text"] {
    background: #111;
    color: #e0e0e0;
    border: 1px solid #007aaa;
    padding: 8px 12px;
    font-family: inherit;
    font-size: 13px;
    border-radius: 3px;
    width: 260px;
  }
  input[type="text"]::placeholder { color: #4a7a8a; }
  .stats {
    display: flex;
    gap: 20px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .stat-box {
    background: #0d1a20;
    border: 1px solid #003a4a;
    border-radius: 4px;
    padding: 12px 20px;
    text-align: center;
    min-width: 120px;
  }
  .stat-box .num {
    font-size: 28px;
    font-weight: bold;
    color: #00b4ff;
  }
  .stat-box .label {
    font-size: 11px;
    color: #5aa0b8;
    text-transform: uppercase;
    margin-top: 2px;
  }
  .stat-box.wp .num { color: #8cdcff; }
  .stat-box.notwp .num { color: #ffa040; }
  .stat-box.err .num { color: #ff5050; }
  .stat-box.recheck .num { color: #50ff90; }
  .tag.recheck { background: #003a20; color: #50ff90; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  thead th {
    background: #001820;
    color: #00b4ff;
    padding: 10px 12px;
    text-align: left;
    border-bottom: 2px solid #003a4a;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }
  thead th:hover { background: #002a38; }
  thead th .arrow { font-size: 10px; margin-left: 4px; color: #3cc8ff; }
  tbody tr { border-bottom: 1px solid #0d1a20; }
  tbody tr:hover { background: #0d1a20; }
  tbody td {
    padding: 8px 12px;
    white-space: nowrap;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
  }
  .tag.wp { background: #003a50; color: #8cdcff; }
  .tag.not { background: #3a2800; color: #ffa040; }
  .tag.err { background: #3a0000; color: #ff5050; }
  .method {
    color: #5aa0b8;
    font-size: 12px;
  }
  .domain-link {
    color: #3cc8ff;
    text-decoration: none;
  }
  .domain-link:hover { text-decoration: underline; }
  .error-text { color: #ff5050; font-size: 11px; }
  .empty {
    text-align: center;
    padding: 60px;
    color: #3a6070;
    font-size: 15px;
  }
  .export-bar {
    margin-top: 16px;
    display: flex;
    gap: 10px;
  }
  .dropzone {
    border: 2px dashed #007aaa;
    border-radius: 8px;
    padding: 50px 20px;
    text-align: center;
    color: #5aa0b8;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .dropzone:hover, .dropzone.dragover {
    border-color: #00b4ff;
    background: #001a24;
    color: #00b4ff;
  }
  .dropzone .icon { font-size: 36px; margin-bottom: 10px; display: block; }
  .dropzone .hint { font-size: 12px; color: #3a6070; margin-top: 8px; }
  .hidden { display: none !important; }
</style>
</head>
<body>

<h1>WORDPRESS DETERMINER</h1>
<div class="subtitle">Database Viewer</div>

<div id="dropzone" class="dropzone hidden" onclick="document.getElementById('dbfile').click()">
  <span class="icon">&#128450;</span>
  Drag &amp; drop wp-determiner.db here<br>or click to browse
  <div class="hint">Accepts .db / .sqlite / .sqlite3 files</div>
</div>
<input type="file" id="dbfile" accept=".db,.sqlite,.sqlite3" onchange="loadFile(this.files[0])">

<div class="controls hidden" id="controls">
  <button class="btn" onclick="autoLoad().catch(()=>document.getElementById('dbfile').click())">Refresh</button>
  <input type="text" id="search" placeholder="Filter domains..." oninput="renderTable()">
  <button class="btn" id="filterAll" onclick="setFilter('all')">All</button>
  <button class="btn" id="filterWP" onclick="setFilter('wp')">WordPress</button>
  <button class="btn" id="filterNot" onclick="setFilter('not')">Not WP</button>
  <button class="btn" id="filterErr" onclick="setFilter('err')">Errors</button>
  <button class="btn" id="filterRecheck" onclick="setFilter('recheck')">Recheck Finds</button>
</div>

<div class="stats hidden" id="stats">
  <div class="stat-box"><div class="num" id="statTotal">0</div><div class="label">Total Sites</div></div>
  <div class="stat-box wp"><div class="num" id="statWP">0</div><div class="label">WordPress</div></div>
  <div class="stat-box notwp"><div class="num" id="statNot">0</div><div class="label">Not WP</div></div>
  <div class="stat-box err"><div class="num" id="statErr">0</div><div class="label">Errors</div></div>
  <div class="stat-box recheck"><div class="num" id="statRecheck">0</div><div class="label">Recheck Finds</div></div>
</div>

<div id="tableContainer"></div>

<div class="export-bar" id="exportBar" style="display:none;">
  <button class="btn" onclick="exportCSV()">Export CSV</button>
  <button class="btn" onclick="exportWPList()">Export WordPress List (.txt)</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
<script>
let db = null;
let rows = [];
let currentFilter = 'all';
let sortCol = 'domain';
let sortAsc = true;

// Drag and drop
const dropzone = document.getElementById('dropzone');

dropzone.addEventListener('dragover', e => {
  e.preventDefault();
  dropzone.classList.add('dragover');
});
dropzone.addEventListener('dragleave', () => {
  dropzone.classList.remove('dragover');
});
dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('dragover');
  if (e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
});

// Also support full-page drag and drop
document.body.addEventListener('dragover', e => e.preventDefault());
document.body.addEventListener('drop', e => {
  e.preventDefault();
  if (e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
});

async function loadBuffer(buf) {
  const SQL = await initSqlJs({
    locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}`
  });

  db = new SQL.Database(new Uint8Array(buf));

  const res = db.exec("SELECT domain, is_wordpress, method, status_code, error, first_checked, last_checked, times_checked FROM sites ORDER BY domain");
  if (!res.length) {
    document.getElementById('tableContainer').innerHTML = '<div class="empty">Database is empty -- no results yet</div>';
    return;
  }

  rows = res[0].values.map(r => ({
    domain: r[0],
    is_wordpress: r[1],
    method: r[2] || '',
    status_code: r[3] || 0,
    error: r[4] || '',
    first_checked: r[5] || '',
    last_checked: r[6] || '',
    times_checked: r[7] || 1
  }));

  // Hide dropzone, show controls
  document.getElementById('dropzone').classList.add('hidden');
  document.getElementById('controls').classList.remove('hidden');
  document.getElementById('stats').classList.remove('hidden');
  document.getElementById('exportBar').style.display = 'flex';

  updateStats();
  setFilter('all');
}

async function loadFile(file) {
  if (!file) return;
  loadBuffer(await file.arrayBuffer());
}

// Auto-load DB from same directory on page open
async function autoLoad() {
  try {
    const resp = await fetch('./wp-determiner.db');
    if (!resp.ok) throw new Error(resp.status);
    loadBuffer(await resp.arrayBuffer());
  } catch (e) {
    // Browser blocked file:// fetch â€” show dropzone as fallback
    document.getElementById('dropzone').classList.remove('hidden');
  }
}

autoLoad();

function updateStats() {
  document.getElementById('statTotal').textContent = rows.length;
  document.getElementById('statWP').textContent = rows.filter(r => r.is_wordpress === 1).length;
  document.getElementById('statNot').textContent = rows.filter(r => r.is_wordpress === 0 && !r.error).length;
  document.getElementById('statErr').textContent = rows.filter(r => r.error).length;
  document.getElementById('statRecheck').textContent = rows.filter(r => r.is_wordpress === 1 && r.times_checked > 1).length;
}

function setFilter(f) {
  currentFilter = f;
  ['All','WP','Not','Err','Recheck'].forEach(k => {
    document.getElementById('filter'+k).classList.remove('active');
  });
  const map = {all:'All', wp:'WP', not:'Not', err:'Err', recheck:'Recheck'};
  document.getElementById('filter'+map[f]).classList.add('active');
  renderTable();
}

function getFiltered() {
  let data = rows;
  const q = document.getElementById('search').value.toLowerCase();
  if (q) data = data.filter(r => r.domain.toLowerCase().includes(q));
  if (currentFilter === 'wp') data = data.filter(r => r.is_wordpress === 1);
  else if (currentFilter === 'not') data = data.filter(r => r.is_wordpress === 0 && !r.error);
  else if (currentFilter === 'err') data = data.filter(r => !!r.error);
  else if (currentFilter === 'recheck') data = data.filter(r => r.is_wordpress === 1 && r.times_checked > 1);

  data.sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });
  return data;
}

function setSort(col) {
  if (sortCol === col) sortAsc = !sortAsc;
  else { sortCol = col; sortAsc = true; }
  renderTable();
}

function arrow(col) {
  if (sortCol !== col) return '';
  return `<span class="arrow">${sortAsc ? '\u25B2' : '\u25BC'}</span>`;
}

function renderTable() {
  const data = getFiltered();
  if (!data.length) {
    document.getElementById('tableContainer').innerHTML = '<div class="empty">No matching results</div>';
    return;
  }

  let html = `<table>
    <thead><tr>
      <th onclick="setSort('domain')">Domain${arrow('domain')}</th>
      <th onclick="setSort('is_wordpress')">Status${arrow('is_wordpress')}</th>
      <th onclick="setSort('method')">Method${arrow('method')}</th>
      <th onclick="setSort('status_code')">HTTP${arrow('status_code')}</th>
      <th onclick="setSort('times_checked')">Checks${arrow('times_checked')}</th>
      <th onclick="setSort('last_checked')">Last Checked${arrow('last_checked')}</th>
      <th>Error</th>
    </tr></thead><tbody>`;

  for (const r of data) {
    let tag;
    if (r.error) tag = '<span class="tag err">ERR</span>';
    else if (r.is_wordpress && r.times_checked > 1) tag = '<span class="tag recheck">WP (Recheck)</span>';
    else if (r.is_wordpress) tag = '<span class="tag wp">WordPress</span>';
    else tag = '<span class="tag not">Not WP</span>';

    html += `<tr>
      <td><a class="domain-link" href="https://${r.domain}" target="_blank">${r.domain}</a></td>
      <td>${tag}</td>
      <td class="method">${r.method}</td>
      <td>${r.status_code || ''}</td>
      <td>${r.times_checked}</td>
      <td>${r.last_checked}</td>
      <td class="error-text" title="${r.error}">${r.error.length > 50 ? r.error.slice(0,50)+'...' : r.error}</td>
    </tr>`;
  }

  html += '</tbody></table>';
  document.getElementById('tableContainer').innerHTML = html;
}

function exportCSV() {
  const data = getFiltered();
  let csv = 'domain,is_wordpress,method,status_code,error,first_checked,last_checked,times_checked\n';
  for (const r of data) {
    csv += `"${r.domain}",${r.is_wordpress},"${r.method}",${r.status_code},"${r.error.replace(/"/g,'""')}","${r.first_checked}","${r.last_checked}",${r.times_checked}\n`;
  }
  download(csv, 'wp-determiner-export.csv', 'text/csv');
}

function exportWPList() {
  const wpDomains = rows.filter(r => r.is_wordpress === 1).map(r => r.domain).join('\n');
  download(wpDomains, 'wordpress-sites.txt', 'text/plain');
}

function download(content, filename, type) {
  const blob = new Blob([content], {type});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}
</script>
</body>
</html>
